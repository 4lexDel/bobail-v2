(function(){"use strict";var m=function(){function r(t){this.data_=t}return r.prototype.get=function(t){var e=JSON.stringify(t);return this.data_.get(e)},r.prototype.set=function(t,e){var n=JSON.stringify(t);return this.data_.set(n,e),this},r}(),y=function(){function r(t){this.bucketCount_=t,this.buckets_=[];for(var e=0;e<this.bucketCount_;e++)this.buckets_.push(new Map)}return r.prototype.hashFunction_=function(t){var e=0;if(t.length===0)return e;for(var n=0;n<t.length;n++)e=(e<<5)-e,e=e+t.charCodeAt(n),e=e&e;return Math.abs(e)},r.prototype.getBucketIndex_=function(t){return this.hashFunction_(t)%this.bucketCount_},r.prototype.getBucket_=function(t){return this.buckets_[this.getBucketIndex_(t)]},r.prototype.set=function(t,e){return this.getBucket_(t).set(t,e),this},r.prototype.get=function(t){return this.getBucket_(t).get(t)},r}(),g=function(){function r(t){this.decayingParam=t}return r.prototype.run=function(t,e){for(;t;)t.mctsState.visits++,t.mctsState.reward+=e,e*=-1,e*=this.decayingParam,t=t.parent},r}(),v=function(){function r(t){this.generateActions=t.generateActions,this.applyAction=t.applyAction,this.stateIsTerminal=t.stateIsTerminal,this.calculateReward=t.calculateReward}return Object.defineProperty(r.prototype,"generateActions",{get:function(){return this.generateActions_},set:function(t){if(typeof t!="function"||t.length!==1)throw new TypeError("Expected generateActions to be a function that takes one argument.");this.generateActions_=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"applyAction",{get:function(){return this.applyAction_},set:function(t){if(typeof t!="function"||t.length!==2)throw new TypeError("Expected applyAction to be a function that takes two arguments.");this.applyAction_=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"stateIsTerminal",{get:function(){return this.stateIsTerminal_},set:function(t){if(typeof t!="function"||t.length!==1)throw new TypeError("Expected stateIsTerminal to be a function that takes one argument.");this.stateIsTerminal_=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"calculateReward",{get:function(){return this.calculateReward_},set:function(t){if(typeof t!="function"||t.length!==2)throw new TypeError("Expected calculateReward to be a function that takes two arguments.");this.calculateReward_=t},enumerable:!0,configurable:!0}),r}(),w=function(){function r(t,e,n,i){this.mctsState_=t,this.parent_=n,this.action_=i,this.children_=[],this.possibleActionsLeftToExpand_=e}return Object.defineProperty(r.prototype,"mctsState",{get:function(){return this.mctsState_},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"possibleActionsLeftToExpand",{get:function(){return this.possibleActionsLeftToExpand_},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"action",{get:function(){return this.action_},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"children",{get:function(){return this.children_},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"parent",{get:function(){return this.parent_},enumerable:!0,configurable:!0}),r.prototype.addChild=function(t,e,n){var i=new r(t,e,this,n);return this.children_.push(i),i},r.prototype.isNotFullyExpanded=function(){return this.possibleActionsLeftToExpand_.length>0},r}(),p=function(){function r(t){this.state_=t,this.reward_=0,this.visits_=0}return Object.defineProperty(r.prototype,"reward",{get:function(){return this.reward_},set:function(t){this.reward_=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"visits",{get:function(){return this.visits_},set:function(t){this.visits_=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"state",{get:function(){return this.state_},enumerable:!0,configurable:!0}),r}(),h;try{if(typeof window<"u")h=performance.now;else{var A=require("perf_hooks").performance;h=A.now}}catch{h=Date.now}var d=function(r,t){return r=Math.ceil(r),t=Math.floor(t),Math.floor(Math.random()*(t-r+1))+r},T=function(r){var t=d(0,r.length-1);return r.splice(t,1)[0]},_=function(r){return{milliseconds:function(t){for(var e=h();h()-e<r&&!t(););},seconds:function(t){for(var e=h(),n=r*1e3;h()-e<n&&!t(););},turns:function(t){for(;r>0&&!t();)r--}}},S=function(){function r(t,e,n){this.applyAction_=t,this.generateActions_=e,this.dataStore_=n}return r.prototype.run=function(t){var e=T(t.possibleActionsLeftToExpand),n=this.applyAction_(t.mctsState.state,e),i=this.dataStore_.get(n);i||(i=new p(n),this.dataStore_.set(n,i));var a=t.addChild(i,this.generateActions_(n),e);return a},r}();/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */function k(r,t,e,n){return new(e||(e=Promise))(function(i,a){function s(o){try{u(n.next(o))}catch(l){a(l)}}function c(o){try{u(n.throw(o))}catch(l){a(l)}}function u(o){o.done?i(o.value):new e(function(l){l(o.value)}).then(s,c)}u((n=n.apply(r,[])).next())})}function C(r,t){var e={label:0,sent:function(){if(a[0]&1)throw a[1];return a[1]},trys:[],ops:[]},n,i,a,s;return s={next:c(0),throw:c(1),return:c(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function c(o){return function(l){return u([o,l])}}function u(o){if(n)throw new TypeError("Generator is already executing.");for(;e;)try{if(n=1,i&&(a=i[o[0]&2?"return":o[0]?"throw":"next"])&&!(a=a.call(i,o[1])).done)return a;switch(i=0,a&&(o=[0,a.value]),o[0]){case 0:case 1:a=o;break;case 4:return e.label++,{value:o[1],done:!1};case 5:e.label++,i=o[1],o=[0];continue;case 7:o=e.ops.pop(),e.trys.pop();continue;default:if(a=e.trys,!(a=a.length>0&&a[a.length-1])&&(o[0]===6||o[0]===2)){e=0;continue}if(o[0]===3&&(!a||o[1]>a[0]&&o[1]<a[3])){e.label=o[1];break}if(o[0]===6&&e.label<a[1]){e.label=a[1],a=o;break}if(a&&e.label<a[2]){e.label=a[2],e.ops.push(o);break}a[2]&&e.ops.pop(),e.trys.pop();continue}o=t.call(r,e)}catch(l){o=[6,l],i=0}finally{n=a=0}if(o[0]&5)throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}}var x=function(){function r(t,e,n,i,a,s,c,u,o){this.select_=t,this.expand_=e,this.simulate_=n,this.backPropagate_=i,this.bestChild_=a,this.generateActions_=s,this.dataStore_=c,this.duration_=u,this.explorationParam_=o}return r.prototype.getAction=function(t,e){return k(this,void 0,void 0,function(){var n=this,i,a,s,c;return C(this,function(u){switch(u.label){case 0:return i=this.createRootNode_(t),a=h(),s=new Promise(function(o){var l=function(){if(h()-a>=(e||n.duration_))return o();_(30).milliseconds(function(){var b=n.select_.run(i),O=n.simulate_.run(b.mctsState.state);n.backPropagate_.run(b,O)}),setTimeout(l)};l()}),[4,s];case 1:return u.sent(),c=this.bestChild_.run(i,!0),[2,c.action]}})})},r.prototype.getActionSync=function(t,e){var n=this,i=this.createRootNode_(t);_(e||this.duration_).milliseconds(function(){var s=n.select_.run(i),c=n.simulate_.run(s.mctsState.state);n.backPropagate_.run(s,c)});var a=this.bestChild_.run(i,!0);return a.action},r.prototype.createRootNode_=function(t){var e=this.dataStore_.get(t);e||(e=new p(t),this.dataStore_.set(t,e));var n=new w(e,this.generateActions_(t));return n},r}(),M=function(){function r(t){this.UCB1_=t}return r.prototype.run=function(t,e){var n=this;if(e===void 0&&(e=!1),!!t.children.length){var i=t.children.reduce(function(s,c){return s+c.mctsState.visits},0),a=t.children.reduce(function(s,c){return n.UCB1_.run(i,s.mctsState,e)>n.UCB1_.run(i,c.mctsState,e)?s:c});return a}},r}(),I=function(){function r(t){this.explorationParam_=t}return r.prototype.run=function(t,e,n){n===void 0&&(n=!1),n&&(this.explorationParam_=0);var i=e.reward/e.visits,a=Math.sqrt(Math.log(t)/e.visits);return i+this.explorationParam_*a},r}(),P=function(){function r(t,e,n,i,a){this.stateIsTerminal_=t,this.expand_=e,this.bestChild_=n,this.ucb1_=i,this.fpuParam_=a}return r.prototype.run=function(t){for(;!this.stateIsTerminal_(t.mctsState.state);){var e=this.bestChild_.run(t);if(!e)return this.expand_.run(t);if(t.isNotFullyExpanded()){var n=t.children.reduce(function(a,s){return a+s.mctsState.visits},0),i=this.ucb1_.run(n,e.mctsState);if(i<this.fpuParam_)return this.expand_.run(t)}t=e}return t},r}(),R=function(){function r(t,e,n,i){this.stateIsTerminal_=t,this.generateActions_=e,this.applyAction_=n,this.calculateReward_=i}return r.prototype.run=function(t){for(var e=t.player;!this.stateIsTerminal_(t);){var n=this.generateActions_(t),i=d(0,n.length-1),a=n[i];t=this.applyAction_(t,a)}return this.calculateReward_(t,e)},r}(),D=function(){function r(t,e){this.duration_=e.duration,this.explorationParam_=e.explorationParam||1.414,this.fpuParam_=e.fpuParam||1/0,this.decayingParam_=e.decayingParam||1,this.transpoTable_=e.transpoTable,this.init(t)}return r.prototype.init=function(t){var e;this.transpoTable_?e=new y(this.transpoTable_):e=new Map;var n=new m(e),i=new I(this.explorationParam_),a=new M(i),s=new S(t.applyAction,t.generateActions,n),c=new P(t.stateIsTerminal,s,a,i,this.fpuParam_),u=new R(t.stateIsTerminal,t.generateActions,t.applyAction,t.calculateReward),o=new g(this.decayingParam_);this.mcts_=new x(c,s,u,o,a,t.generateActions,n,this.duration_,this.explorationParam_)},r.prototype.getAction=function(t,e){return this.mcts_.getAction(t,e)},r.prototype.getActionSync=function(t,e){return this.mcts_.getActionSync(t,e)},r}(),E=function(){function r(t,e){var n=new v(t);this.controller_=new D(n,e)}return r.prototype.getAction=function(t,e){return this.controller_.getAction(t,e)},r.prototype.getActionSync=function(t,e){return this.controller_.getActionSync(t,e)},r}();class f{static checkGameOver(t,e){return this.checkWin(t,e)?e:this.isGridFull(t)?0:null}static checkWin(t,e){return this.checkHorizontalWin(t,e)||this.checkVerticalWin(t,e)||this.checkDiagonalWin(t,e)}static checkDiagonalWin(t,e){for(let n=0;n<4;n++)for(let i=0;i<3;i++)if(t[n][i]===e&&t[n+1][i+1]===e&&t[n+2][i+2]===e&&t[n+3][i+3]===e)return!0;for(let n=3;n<7;n++)for(let i=0;i<3;i++)if(t[n][i]===e&&t[n-1][i+1]===e&&t[n-2][i+2]===e&&t[n-3][i+3]===e)return!0;return!1}static checkVerticalWin(t,e){for(let n=0;n<7;n++)for(let i=0;i<3;i++)if(t[n][i]===e&&t[n][i+1]===e&&t[n][i+2]===e&&t[n][i+3]===e)return!0;return!1}static checkHorizontalWin(t,e){for(let n=0;n<6;n++)for(let i=0;i<4;i++)if(t[i][n]===e&&t[i+1][n]===e&&t[i+2][n]===e&&t[i+3][n]===e)return!0;return!1}static isGridFull(t){return t.every(e=>e.every(n=>n!==0))}}class B{constructor(){}findBestMove(t,e,n){const i={generateActions:this.generateActions,applyAction:this.applyAction,stateIsTerminal:this.stateIsTerminal,calculateReward:this.calculateReward},a={duration:n};return new E(i,a).getAction({board:t.map(c=>[...c]),player:e})}generateActions(t){const e=[];for(let n=0;n<7;n++)t.board[n][0]===0&&e.push({column:n});return e}applyAction(t,e){const n=t.board.map(a=>[...a]);if(e.column<0||e.column>=7)return t;const i=e.column;for(let a=5;a>=0;a--)if(n[i][a]===0){n[i][a]=t.player;break}return{board:n,player:t.player===1?2:1}}stateIsTerminal(t){return f.isGridFull(t.board)||f.checkWin(t.board,1)||f.checkWin(t.board,2)}calculateReward(t,e){return f.checkWin(t.board,e)?-1:f.checkWin(t.board,e===1?2:1)?1:(f.isGridFull(t.board),0)}}onmessage=async r=>{const{grid:t,player:e,reflexionTime:n}=r.data,a=await new B().findBestMove(t,e,n);postMessage({nextAction:a})}})();
