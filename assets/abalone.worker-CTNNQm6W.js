var Y=Object.defineProperty;var K=(g,y,v)=>y in g?Y(g,y,{enumerable:!0,configurable:!0,writable:!0,value:v}):g[y]=v;var I=(g,y,v)=>K(g,typeof y!="symbol"?y+"":y,v);(function(){"use strict";var g=function(){function r(t){this.data_=t}return r.prototype.get=function(t){var e=JSON.stringify(t);return this.data_.get(e)},r.prototype.set=function(t,e){var n=JSON.stringify(t);return this.data_.set(n,e),this},r}(),y=function(){function r(t){this.bucketCount_=t,this.buckets_=[];for(var e=0;e<this.bucketCount_;e++)this.buckets_.push(new Map)}return r.prototype.hashFunction_=function(t){var e=0;if(t.length===0)return e;for(var n=0;n<t.length;n++)e=(e<<5)-e,e=e+t.charCodeAt(n),e=e&e;return Math.abs(e)},r.prototype.getBucketIndex_=function(t){return this.hashFunction_(t)%this.bucketCount_},r.prototype.getBucket_=function(t){return this.buckets_[this.getBucketIndex_(t)]},r.prototype.set=function(t,e){return this.getBucket_(t).set(t,e),this},r.prototype.get=function(t){return this.getBucket_(t).get(t)},r}(),v=function(){function r(t){this.decayingParam=t}return r.prototype.run=function(t,e){for(;t;)t.mctsState.visits++,t.mctsState.reward+=e,e*=-1,e*=this.decayingParam,t=t.parent},r}(),k=function(){function r(t){this.generateActions=t.generateActions,this.applyAction=t.applyAction,this.stateIsTerminal=t.stateIsTerminal,this.calculateReward=t.calculateReward}return Object.defineProperty(r.prototype,"generateActions",{get:function(){return this.generateActions_},set:function(t){if(typeof t!="function"||t.length!==1)throw new TypeError("Expected generateActions to be a function that takes one argument.");this.generateActions_=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"applyAction",{get:function(){return this.applyAction_},set:function(t){if(typeof t!="function"||t.length!==2)throw new TypeError("Expected applyAction to be a function that takes two arguments.");this.applyAction_=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"stateIsTerminal",{get:function(){return this.stateIsTerminal_},set:function(t){if(typeof t!="function"||t.length!==1)throw new TypeError("Expected stateIsTerminal to be a function that takes one argument.");this.stateIsTerminal_=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"calculateReward",{get:function(){return this.calculateReward_},set:function(t){if(typeof t!="function"||t.length!==2)throw new TypeError("Expected calculateReward to be a function that takes two arguments.");this.calculateReward_=t},enumerable:!0,configurable:!0}),r}(),R=function(){function r(t,e,n,a){this.mctsState_=t,this.parent_=n,this.action_=a,this.children_=[],this.possibleActionsLeftToExpand_=e}return Object.defineProperty(r.prototype,"mctsState",{get:function(){return this.mctsState_},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"possibleActionsLeftToExpand",{get:function(){return this.possibleActionsLeftToExpand_},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"action",{get:function(){return this.action_},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"children",{get:function(){return this.children_},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"parent",{get:function(){return this.parent_},enumerable:!0,configurable:!0}),r.prototype.addChild=function(t,e,n){var a=new r(t,e,this,n);return this.children_.push(a),a},r.prototype.isNotFullyExpanded=function(){return this.possibleActionsLeftToExpand_.length>0},r}(),T=function(){function r(t){this.state_=t,this.reward_=0,this.visits_=0}return Object.defineProperty(r.prototype,"reward",{get:function(){return this.reward_},set:function(t){this.reward_=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"visits",{get:function(){return this.visits_},set:function(t){this.visits_=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"state",{get:function(){return this.state_},enumerable:!0,configurable:!0}),r}(),_;try{if(typeof window<"u")_=performance.now;else{var E=require("perf_hooks").performance;_=E.now}}catch{_=Date.now}var P=function(r,t){return r=Math.ceil(r),t=Math.floor(t),Math.floor(Math.random()*(t-r+1))+r},O=function(r){var t=P(0,r.length-1);return r.splice(t,1)[0]},C=function(r){return{milliseconds:function(t){for(var e=_();_()-e<r&&!t(););},seconds:function(t){for(var e=_(),n=r*1e3;_()-e<n&&!t(););},turns:function(t){for(;r>0&&!t();)r--}}},D=function(){function r(t,e,n){this.applyAction_=t,this.generateActions_=e,this.dataStore_=n}return r.prototype.run=function(t){var e=O(t.possibleActionsLeftToExpand),n=this.applyAction_(t.mctsState.state,e),a=this.dataStore_.get(n);a||(a=new T(n),this.dataStore_.set(n,a));var i=t.addChild(a,this.generateActions_(n),e);return i},r}();/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */function j(r,t,e,n){return new(e||(e=Promise))(function(a,i){function s(o){try{l(n.next(o))}catch(u){i(u)}}function c(o){try{l(n.throw(o))}catch(u){i(u)}}function l(o){o.done?a(o.value):new e(function(u){u(o.value)}).then(s,c)}l((n=n.apply(r,[])).next())})}function N(r,t){var e={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,a,i,s;return s={next:c(0),throw:c(1),return:c(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function c(o){return function(u){return l([o,u])}}function l(o){if(n)throw new TypeError("Generator is already executing.");for(;e;)try{if(n=1,a&&(i=a[o[0]&2?"return":o[0]?"throw":"next"])&&!(i=i.call(a,o[1])).done)return i;switch(a=0,i&&(o=[0,i.value]),o[0]){case 0:case 1:i=o;break;case 4:return e.label++,{value:o[1],done:!1};case 5:e.label++,a=o[1],o=[0];continue;case 7:o=e.ops.pop(),e.trys.pop();continue;default:if(i=e.trys,!(i=i.length>0&&i[i.length-1])&&(o[0]===6||o[0]===2)){e=0;continue}if(o[0]===3&&(!i||o[1]>i[0]&&o[1]<i[3])){e.label=o[1];break}if(o[0]===6&&e.label<i[1]){e.label=i[1],i=o;break}if(i&&e.label<i[2]){e.label=i[2],e.ops.push(o);break}i[2]&&e.ops.pop(),e.trys.pop();continue}o=t.call(r,e)}catch(u){o=[6,u],a=0}finally{n=i=0}if(o[0]&5)throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}}var L=function(){function r(t,e,n,a,i,s,c,l,o){this.select_=t,this.expand_=e,this.simulate_=n,this.backPropagate_=a,this.bestChild_=i,this.generateActions_=s,this.dataStore_=c,this.duration_=l,this.explorationParam_=o}return r.prototype.getAction=function(t,e){return j(this,void 0,void 0,function(){var n=this,a,i,s,c;return N(this,function(l){switch(l.label){case 0:return a=this.createRootNode_(t),i=_(),s=new Promise(function(o){var u=function(){if(_()-i>=(e||n.duration_))return o();C(30).milliseconds(function(){var f=n.select_.run(a),d=n.simulate_.run(f.mctsState.state);n.backPropagate_.run(f,d)}),setTimeout(u)};u()}),[4,s];case 1:return l.sent(),c=this.bestChild_.run(a,!0),[2,c.action]}})})},r.prototype.getActionSync=function(t,e){var n=this,a=this.createRootNode_(t);C(e||this.duration_).milliseconds(function(){var s=n.select_.run(a),c=n.simulate_.run(s.mctsState.state);n.backPropagate_.run(s,c)});var i=this.bestChild_.run(a,!0);return i.action},r.prototype.createRootNode_=function(t){var e=this.dataStore_.get(t);e||(e=new T(t),this.dataStore_.set(t,e));var n=new R(e,this.generateActions_(t));return n},r}(),F=function(){function r(t){this.UCB1_=t}return r.prototype.run=function(t,e){var n=this;if(e===void 0&&(e=!1),!!t.children.length){var a=t.children.reduce(function(s,c){return s+c.mctsState.visits},0),i=t.children.reduce(function(s,c){return n.UCB1_.run(a,s.mctsState,e)>n.UCB1_.run(a,c.mctsState,e)?s:c});return i}},r}(),G=function(){function r(t){this.explorationParam_=t}return r.prototype.run=function(t,e,n){n===void 0&&(n=!1),n&&(this.explorationParam_=0);var a=e.reward/e.visits,i=Math.sqrt(Math.log(t)/e.visits);return a+this.explorationParam_*i},r}(),U=function(){function r(t,e,n,a,i){this.stateIsTerminal_=t,this.expand_=e,this.bestChild_=n,this.ucb1_=a,this.fpuParam_=i}return r.prototype.run=function(t){for(;!this.stateIsTerminal_(t.mctsState.state);){var e=this.bestChild_.run(t);if(!e)return this.expand_.run(t);if(t.isNotFullyExpanded()){var n=t.children.reduce(function(i,s){return i+s.mctsState.visits},0),a=this.ucb1_.run(n,e.mctsState);if(a<this.fpuParam_)return this.expand_.run(t)}t=e}return t},r}(),V=function(){function r(t,e,n,a){this.stateIsTerminal_=t,this.generateActions_=e,this.applyAction_=n,this.calculateReward_=a}return r.prototype.run=function(t){for(var e=t.player;!this.stateIsTerminal_(t);){var n=this.generateActions_(t),a=P(0,n.length-1),i=n[a];t=this.applyAction_(t,i)}return this.calculateReward_(t,e)},r}(),q=function(){function r(t,e){this.duration_=e.duration,this.explorationParam_=e.explorationParam||1.414,this.fpuParam_=e.fpuParam||1/0,this.decayingParam_=e.decayingParam||1,this.transpoTable_=e.transpoTable,this.init(t)}return r.prototype.init=function(t){var e;this.transpoTable_?e=new y(this.transpoTable_):e=new Map;var n=new g(e),a=new G(this.explorationParam_),i=new F(a),s=new D(t.applyAction,t.generateActions,n),c=new U(t.stateIsTerminal,s,i,a,this.fpuParam_),l=new V(t.stateIsTerminal,t.generateActions,t.applyAction,t.calculateReward),o=new v(this.decayingParam_);this.mcts_=new L(c,s,l,o,i,t.generateActions,n,this.duration_,this.explorationParam_)},r.prototype.getAction=function(t,e){return this.mcts_.getAction(t,e)},r.prototype.getActionSync=function(t,e){return this.mcts_.getActionSync(t,e)},r}(),H=function(){function r(t,e){var n=new k(t);this.controller_=new q(n,e)}return r.prototype.getAction=function(t,e){return this.controller_.getAction(t,e)},r.prototype.getActionSync=function(t,e){return this.controller_.getActionSync(t,e)},r}();const h=class h{static cloneBoard(t){return t.map(e=>[...e])}static isInsideBoard(t,e,n){return e>=0&&e<n[0].length&&t>=0&&t<n.length&&n[t][e]!==-2}static getAvailableMoves(t,e){const n=[],a=t[e.x][e.y];if(a!==1&&a!==2)return n;const i=a===1?2:1;for(const{dx:s,dy:c}of h.directions){let l=[{x:e.x,y:e.y}],o=e.x+s,u=e.y+c;for(;h.isInsideBoard(o,u,t)&&t[o][u]===a&&l.length<3;)l.push({x:o,y:u}),o+=s,u+=c;let f=0,d=o,w=u;for(;h.isInsideBoard(d,w,t)&&t[d][w]===i&&f<l.length;)f++,d+=s,w+=c;f===0&&h.isInsideBoard(o,u,t)&&t[o][u]===0&&n.push({x:o,y:u});const x=d,S=w,b=h.isInsideBoard(x,S,t)?t[x][S]===0:!0;f>0&&f<l.length&&b&&n.push({x:e.x+s*(l.length+f),y:e.y+c*(l.length+f)})}return n}static getDirection(t,e){for(const n of h.directions)if(t.x+n.dx===e.x&&t.y+n.dy===e.y)return n;return null}static applyMove(t,e,n){const a=Math.abs(n.x-e.x),i=Math.abs(n.y-e.y);if(a!==0&&i!==0&&a!==i||a===0&&i===0)return[];const s=h.cloneBoard(t),c=(n.x-e.x)/a||0,l=(n.y-e.y)/i||0;let o=e.x,u=e.y,f=s[o][u];for(;o!==n.x||u!==n.y;)if(o+=c,u+=l,h.isInsideBoard(o,u,s)){const d=s[o][u];s[o][u]=f,f=d}return s[e.x][e.y]=0,s}static countPlayerPiecesLost(t){const e={player1:14,player2:14};for(let n=0;n<t.length;n++)for(let a=0;a<t[0].length;a++)t[n][a]===1?e.player1--:t[n][a]===2&&e.player2--;return e}static isGameOver(t){const e=h.countPlayerPiecesLost(t);return e.player1>=6||e.player2>=6}static generateActions(t){const e=[];for(let n=0;n<t.board.length;n++)for(let a=0;a<t.board[0].length;a++)if(t.board[n][a]===t.player){const i=h.getAvailableMoves(t.board,{x:n,y:a});i.length&&e.push(...i.map(s=>({from:{x:n,y:a},to:s})))}return e}static applyAction(t,e){return{board:h.applyMove(t.board,e.from,e.to),player:t.player===1?2:1}}static distance(t,e){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}static evaluateBoard(t,e){const a={x:5,y:5},i=e===1?2:1;let s=0,c=0,l=0,o=0;const u=[];for(let b=0;b<t.length;b++)for(let m=0;m<t[0].length;m++){const A=t[b][m];A===e?(s++,u.push({x:b,y:m}),l+=10-2*h.distance({x:b,y:m},a)):A===i&&c++}for(const{x:b,y:m}of u)for(const{dx:A,dy:X}of h.directions){const B=b+A,M=m+X;h.isInsideBoard(B,M,t)&&t[B][M]===e&&(o+=2)}const f=14-s,d=14-c,w=(s-c)*10,x=d*100-f*100;return w+x+l+o}};I(h,"directions",[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:1,dy:-1},{dx:0,dy:1},{dx:-1,dy:1}]);let p=h;class J{constructor(){}findBestMove(t,e,n){const a={generateActions:this.generateActions,applyAction:this.applyAction,stateIsTerminal:this.stateIsTerminal,calculateReward:this.calculateReward},i={duration:n};return new H(a,i).getAction({board:t.map(c=>[...c]),player:e})}generateActions(t){return p.generateActions(t)}applyAction(t,e){return p.applyAction(t,e)}stateIsTerminal(t){return p.isGameOver(t.board)}calculateReward(t,e){let n=t;for(;!p.isGameOver(t.board);){const i=p.generateActions(n);i.map(c=>{const l=p.applyAction(t,c);return{action:c,score:p.evaluateBoard(l.board,l.player)}}).sort((c,l)=>l.score-c.score).map(c=>c.action);const s=i[0];n=p.applyAction(n,s)}const a=p.countPlayerPiecesLost(t.board);return a.player1>=6?e===1?1:-1:a.player2>=6?e===1?-1:1:0}}onmessage=async r=>{const{grid:t,player:e,reflexionTime:n}=r.data,i=await new J().findBestMove(t,e,n);postMessage({nextAction:i})}})();
