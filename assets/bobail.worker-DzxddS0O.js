(function(){"use strict";var w=function(){function n(t){this.data_=t}return n.prototype.get=function(t){var e=JSON.stringify(t);return this.data_.get(e)},n.prototype.set=function(t,e){var r=JSON.stringify(t);return this.data_.set(r,e),this},n}(),P=function(){function n(t){this.bucketCount_=t,this.buckets_=[];for(var e=0;e<this.bucketCount_;e++)this.buckets_.push(new Map)}return n.prototype.hashFunction_=function(t){var e=0;if(t.length===0)return e;for(var r=0;r<t.length;r++)e=(e<<5)-e,e=e+t.charCodeAt(r),e=e&e;return Math.abs(e)},n.prototype.getBucketIndex_=function(t){return this.hashFunction_(t)%this.bucketCount_},n.prototype.getBucket_=function(t){return this.buckets_[this.getBucketIndex_(t)]},n.prototype.set=function(t,e){return this.getBucket_(t).set(t,e),this},n.prototype.get=function(t){return this.getBucket_(t).get(t)},n}(),A=function(){function n(t){this.decayingParam=t}return n.prototype.run=function(t,e){for(;t;)t.mctsState.visits++,t.mctsState.reward+=e,e*=-1,e*=this.decayingParam,t=t.parent},n}(),T=function(){function n(t){this.generateActions=t.generateActions,this.applyAction=t.applyAction,this.stateIsTerminal=t.stateIsTerminal,this.calculateReward=t.calculateReward}return Object.defineProperty(n.prototype,"generateActions",{get:function(){return this.generateActions_},set:function(t){if(typeof t!="function"||t.length!==1)throw new TypeError("Expected generateActions to be a function that takes one argument.");this.generateActions_=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"applyAction",{get:function(){return this.applyAction_},set:function(t){if(typeof t!="function"||t.length!==2)throw new TypeError("Expected applyAction to be a function that takes two arguments.");this.applyAction_=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"stateIsTerminal",{get:function(){return this.stateIsTerminal_},set:function(t){if(typeof t!="function"||t.length!==1)throw new TypeError("Expected stateIsTerminal to be a function that takes one argument.");this.stateIsTerminal_=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"calculateReward",{get:function(){return this.calculateReward_},set:function(t){if(typeof t!="function"||t.length!==2)throw new TypeError("Expected calculateReward to be a function that takes two arguments.");this.calculateReward_=t},enumerable:!0,configurable:!0}),n}(),S=function(){function n(t,e,r,o){this.mctsState_=t,this.parent_=r,this.action_=o,this.children_=[],this.possibleActionsLeftToExpand_=e}return Object.defineProperty(n.prototype,"mctsState",{get:function(){return this.mctsState_},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"possibleActionsLeftToExpand",{get:function(){return this.possibleActionsLeftToExpand_},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"action",{get:function(){return this.action_},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"children",{get:function(){return this.children_},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"parent",{get:function(){return this.parent_},enumerable:!0,configurable:!0}),n.prototype.addChild=function(t,e,r){var o=new n(t,e,this,r);return this.children_.push(o),o},n.prototype.isNotFullyExpanded=function(){return this.possibleActionsLeftToExpand_.length>0},n}(),g=function(){function n(t){this.state_=t,this.reward_=0,this.visits_=0}return Object.defineProperty(n.prototype,"reward",{get:function(){return this.reward_},set:function(t){this.reward_=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"visits",{get:function(){return this.visits_},set:function(t){this.visits_=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"state",{get:function(){return this.state_},enumerable:!0,configurable:!0}),n}(),d;try{if(typeof window<"u")d=performance.now;else{var C=require("perf_hooks").performance;d=C.now}}catch{d=Date.now}var m=function(n,t){return n=Math.ceil(n),t=Math.floor(t),Math.floor(Math.random()*(t-n+1))+n},B=function(n){var t=m(0,n.length-1);return n.splice(t,1)[0]},x=function(n){return{milliseconds:function(t){for(var e=d();d()-e<n&&!t(););},seconds:function(t){for(var e=d(),r=n*1e3;d()-e<r&&!t(););},turns:function(t){for(;n>0&&!t();)n--}}},k=function(){function n(t,e,r){this.applyAction_=t,this.generateActions_=e,this.dataStore_=r}return n.prototype.run=function(t){var e=B(t.possibleActionsLeftToExpand),r=this.applyAction_(t.mctsState.state,e),o=this.dataStore_.get(r);o||(o=new g(r),this.dataStore_.set(r,o));var i=t.addChild(o,this.generateActions_(r),e);return i},n}();/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */function M(n,t,e,r){return new(e||(e=Promise))(function(o,i){function s(a){try{u(r.next(a))}catch(c){i(c)}}function l(a){try{u(r.throw(a))}catch(c){i(c)}}function u(a){a.done?o(a.value):new e(function(c){c(a.value)}).then(s,l)}u((r=r.apply(n,[])).next())})}function I(n,t){var e={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},r,o,i,s;return s={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function l(a){return function(c){return u([a,c])}}function u(a){if(r)throw new TypeError("Generator is already executing.");for(;e;)try{if(r=1,o&&(i=o[a[0]&2?"return":a[0]?"throw":"next"])&&!(i=i.call(o,a[1])).done)return i;switch(o=0,i&&(a=[0,i.value]),a[0]){case 0:case 1:i=a;break;case 4:return e.label++,{value:a[1],done:!1};case 5:e.label++,o=a[1],a=[0];continue;case 7:a=e.ops.pop(),e.trys.pop();continue;default:if(i=e.trys,!(i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){e=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){e.label=a[1];break}if(a[0]===6&&e.label<i[1]){e.label=i[1],i=a;break}if(i&&e.label<i[2]){e.label=i[2],e.ops.push(a);break}i[2]&&e.ops.pop(),e.trys.pop();continue}a=t.call(n,e)}catch(c){a=[6,c],o=0}finally{r=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}}var E=function(){function n(t,e,r,o,i,s,l,u,a){this.select_=t,this.expand_=e,this.simulate_=r,this.backPropagate_=o,this.bestChild_=i,this.generateActions_=s,this.dataStore_=l,this.duration_=u,this.explorationParam_=a}return n.prototype.getAction=function(t,e){return M(this,void 0,void 0,function(){var r=this,o,i,s,l;return I(this,function(u){switch(u.label){case 0:return o=this.createRootNode_(t),i=d(),s=new Promise(function(a){var c=function(){if(d()-i>=(e||r.duration_))return a();x(30).milliseconds(function(){var f=r.select_.run(o),h=r.simulate_.run(f.mctsState.state);r.backPropagate_.run(f,h)}),setTimeout(c)};c()}),[4,s];case 1:return u.sent(),l=this.bestChild_.run(o,!0),[2,l.action]}})})},n.prototype.getActionSync=function(t,e){var r=this,o=this.createRootNode_(t);x(e||this.duration_).milliseconds(function(){var s=r.select_.run(o),l=r.simulate_.run(s.mctsState.state);r.backPropagate_.run(s,l)});var i=this.bestChild_.run(o,!0);return i.action},n.prototype.createRootNode_=function(t){var e=this.dataStore_.get(t);e||(e=new g(t),this.dataStore_.set(t,e));var r=new S(e,this.generateActions_(t));return r},n}(),R=function(){function n(t){this.UCB1_=t}return n.prototype.run=function(t,e){var r=this;if(e===void 0&&(e=!1),!!t.children.length){var o=t.children.reduce(function(s,l){return s+l.mctsState.visits},0),i=t.children.reduce(function(s,l){return r.UCB1_.run(o,s.mctsState,e)>r.UCB1_.run(o,l.mctsState,e)?s:l});return i}},n}(),j=function(){function n(t){this.explorationParam_=t}return n.prototype.run=function(t,e,r){r===void 0&&(r=!1),r&&(this.explorationParam_=0);var o=e.reward/e.visits,i=Math.sqrt(Math.log(t)/e.visits);return o+this.explorationParam_*i},n}(),D=function(){function n(t,e,r,o,i){this.stateIsTerminal_=t,this.expand_=e,this.bestChild_=r,this.ucb1_=o,this.fpuParam_=i}return n.prototype.run=function(t){for(;!this.stateIsTerminal_(t.mctsState.state);){var e=this.bestChild_.run(t);if(!e)return this.expand_.run(t);if(t.isNotFullyExpanded()){var r=t.children.reduce(function(i,s){return i+s.mctsState.visits},0),o=this.ucb1_.run(r,e.mctsState);if(o<this.fpuParam_)return this.expand_.run(t)}t=e}return t},n}(),O=function(){function n(t,e,r,o){this.stateIsTerminal_=t,this.generateActions_=e,this.applyAction_=r,this.calculateReward_=o}return n.prototype.run=function(t){for(var e=t.player;!this.stateIsTerminal_(t);){var r=this.generateActions_(t),o=m(0,r.length-1),i=r[o];t=this.applyAction_(t,i)}return this.calculateReward_(t,e)},n}(),N=function(){function n(t,e){this.duration_=e.duration,this.explorationParam_=e.explorationParam||1.414,this.fpuParam_=e.fpuParam||1/0,this.decayingParam_=e.decayingParam||1,this.transpoTable_=e.transpoTable,this.init(t)}return n.prototype.init=function(t){var e;this.transpoTable_?e=new P(this.transpoTable_):e=new Map;var r=new w(e),o=new j(this.explorationParam_),i=new R(o),s=new k(t.applyAction,t.generateActions,r),l=new D(t.stateIsTerminal,s,i,o,this.fpuParam_),u=new O(t.stateIsTerminal,t.generateActions,t.applyAction,t.calculateReward),a=new A(this.decayingParam_);this.mcts_=new E(l,s,u,a,i,t.generateActions,r,this.duration_,this.explorationParam_)},n.prototype.getAction=function(t,e){return this.mcts_.getAction(t,e)},n.prototype.getActionSync=function(t,e){return this.mcts_.getActionSync(t,e)},n}(),F=function(){function n(t,e){var r=new T(t);this.controller_=new N(r,e)}return n.prototype.getAction=function(t,e){return this.controller_.getAction(t,e)},n.prototype.getActionSync=function(t,e){return this.controller_.getActionSync(t,e)},n}();class G{constructor(){}findBestMove(t,e){const r={generateActions:this.generateActions,applyAction:this.applyAction,stateIsTerminal:this.stateIsTerminal,calculateReward:this.calculateReward},o={duration:5e3};return new F(r,o).getAction({board:t,player:e})}generateActions(t){const e=c=>{for(let f=0;f<5;f++)for(let h=0;h<5;h++)if(c[f][h]===3)return{x:f,y:h};return null},r=c=>c.x>=0&&c.x<5&&c.y>=0&&c.y<5,o=c=>[{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1},{x:0,y:-1},{x:0,y:1},{x:1,y:-1},{x:1,y:0},{x:1,y:1}].map(h=>({x:c.x+h.x,y:c.y+h.y})).filter(r.bind(this)),i=(c,f)=>{const h=[];for(let p=0;p<5;p++)for(let y=0;y<5;y++)c[p][y]===f&&h.push({x:p,y});return h},s=(c,f)=>{const h=[],p=[{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1},{x:0,y:-1},{x:0,y:1},{x:1,y:-1},{x:1,y:0},{x:1,y:1}];for(const y of p){let b=f.x+y.x,_=f.y+y.y,v=!1;for(;r({x:b,y:_})&&c[b][_]===0;)b+=y.x,_+=y.y,v=!0;v&&h.push({x:b-y.x,y:_-y.y})}return h},l=[],u=e(t.board);if(!u)throw new Error("Bobail is missing from the grid");let a=o(u).filter(c=>t.board[c.x][c.y]===0);for(const c of a){const f=t.board.map(p=>[...p]);f[u.x][u.y]=0,f[c.x][c.y]=3;const h=i(f,t.player);for(const p of h){const y=s(f,p);for(const b of y)l.push({bobailPosition:{from:{x:u.x,y:u.y},to:{x:c.x,y:c.y}},piecePosition:{from:{x:p.x,y:p.y},to:{x:b.x,y:b.y}}})}}return l}applyAction(t,e){const r=t.board.map(o=>[...o]);return e.bobailPosition&&(r[e.bobailPosition.from.x][e.bobailPosition.from.y]=0,r[e.bobailPosition.to.x][e.bobailPosition.to.y]=3),r[e.piecePosition.from.x][e.piecePosition.from.y]=0,r[e.piecePosition.to.x][e.piecePosition.to.y]=t.player,{board:r,player:t.player===1?2:1}}stateIsTerminal(t){const e=s=>{for(let l=0;l<5;l++)for(let u=0;u<5;u++)if(s[l][u]===3)return{x:l,y:u};return null},r=s=>s.x>=0&&s.x<5&&s.y>=0&&s.y<5,o=s=>[{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1},{x:0,y:-1},{x:0,y:1},{x:1,y:-1},{x:1,y:0},{x:1,y:1}].map(u=>({x:s.x+u.x,y:s.y+u.y})).filter(r.bind(this));return(s=>{const l=e(s);if(!l)throw new Error("Bobail required on the grid");return l.y===4||l.y===0||!o(l).filter(a=>s[a.x][a.y]===0).length})(t.board)}calculateReward(t,e){const r=u=>{for(let a=0;a<5;a++)for(let c=0;c<5;c++)if(u[a][c]===3)return{x:a,y:c};return null},o=u=>u.x>=0&&u.x<5&&u.y>=0&&u.y<5,i=u=>[{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1},{x:0,y:-1},{x:0,y:1},{x:1,y:-1},{x:1,y:0},{x:1,y:1}].map(c=>({x:u.x+c.x,y:u.y+c.y})).filter(o.bind(this)),s=r(t.board);return s?s.y===4?e===1?-1:1:s.y===0?e===1?1:-1:i(s).filter(u=>t.board[u.x][u.y]===0).length?0:1:0}}onmessage=async n=>{const{grid:t,player:e}=n.data,o=await new G().findBestMove(t,e);postMessage({nextAction:o})}})();
