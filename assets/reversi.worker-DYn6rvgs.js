var F=Object.defineProperty;var G=(y,p,_)=>p in y?F(y,p,{enumerable:!0,configurable:!0,writable:!0,value:_}):y[p]=_;var b=(y,p,_)=>G(y,typeof p!="symbol"?p+"":p,_);(function(){"use strict";var y=function(){function i(t){this.data_=t}return i.prototype.get=function(t){var e=JSON.stringify(t);return this.data_.get(e)},i.prototype.set=function(t,e){var n=JSON.stringify(t);return this.data_.set(n,e),this},i}(),p=function(){function i(t){this.bucketCount_=t,this.buckets_=[];for(var e=0;e<this.bucketCount_;e++)this.buckets_.push(new Map)}return i.prototype.hashFunction_=function(t){var e=0;if(t.length===0)return e;for(var n=0;n<t.length;n++)e=(e<<5)-e,e=e+t.charCodeAt(n),e=e&e;return Math.abs(e)},i.prototype.getBucketIndex_=function(t){return this.hashFunction_(t)%this.bucketCount_},i.prototype.getBucket_=function(t){return this.buckets_[this.getBucketIndex_(t)]},i.prototype.set=function(t,e){return this.getBucket_(t).set(t,e),this},i.prototype.get=function(t){return this.getBucket_(t).get(t)},i}(),_=function(){function i(t){this.decayingParam=t}return i.prototype.run=function(t,e){for(;t;)t.mctsState.visits++,t.mctsState.reward+=e,e*=-1,e*=this.decayingParam,t=t.parent},i}(),A=function(){function i(t){this.generateActions=t.generateActions,this.applyAction=t.applyAction,this.stateIsTerminal=t.stateIsTerminal,this.calculateReward=t.calculateReward}return Object.defineProperty(i.prototype,"generateActions",{get:function(){return this.generateActions_},set:function(t){if(typeof t!="function"||t.length!==1)throw new TypeError("Expected generateActions to be a function that takes one argument.");this.generateActions_=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"applyAction",{get:function(){return this.applyAction_},set:function(t){if(typeof t!="function"||t.length!==2)throw new TypeError("Expected applyAction to be a function that takes two arguments.");this.applyAction_=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"stateIsTerminal",{get:function(){return this.stateIsTerminal_},set:function(t){if(typeof t!="function"||t.length!==1)throw new TypeError("Expected stateIsTerminal to be a function that takes one argument.");this.stateIsTerminal_=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"calculateReward",{get:function(){return this.calculateReward_},set:function(t){if(typeof t!="function"||t.length!==2)throw new TypeError("Expected calculateReward to be a function that takes two arguments.");this.calculateReward_=t},enumerable:!0,configurable:!0}),i}(),T=function(){function i(t,e,n,a){this.mctsState_=t,this.parent_=n,this.action_=a,this.children_=[],this.possibleActionsLeftToExpand_=e}return Object.defineProperty(i.prototype,"mctsState",{get:function(){return this.mctsState_},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"possibleActionsLeftToExpand",{get:function(){return this.possibleActionsLeftToExpand_},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"action",{get:function(){return this.action_},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"children",{get:function(){return this.children_},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"parent",{get:function(){return this.parent_},enumerable:!0,configurable:!0}),i.prototype.addChild=function(t,e,n){var a=new i(t,e,this,n);return this.children_.push(a),a},i.prototype.isNotFullyExpanded=function(){return this.possibleActionsLeftToExpand_.length>0},i}(),m=function(){function i(t){this.state_=t,this.reward_=0,this.visits_=0}return Object.defineProperty(i.prototype,"reward",{get:function(){return this.reward_},set:function(t){this.reward_=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"visits",{get:function(){return this.visits_},set:function(t){this.visits_=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"state",{get:function(){return this.state_},enumerable:!0,configurable:!0}),i}(),d;try{if(typeof window<"u")d=performance.now;else{var S=require("perf_hooks").performance;d=S.now}}catch{d=Date.now}var v=function(i,t){return i=Math.ceil(i),t=Math.floor(t),Math.floor(Math.random()*(t-i+1))+i},x=function(i){var t=v(0,i.length-1);return i.splice(t,1)[0]},w=function(i){return{milliseconds:function(t){for(var e=d();d()-e<i&&!t(););},seconds:function(t){for(var e=d(),n=i*1e3;d()-e<n&&!t(););},turns:function(t){for(;i>0&&!t();)i--}}},P=function(){function i(t,e,n){this.applyAction_=t,this.generateActions_=e,this.dataStore_=n}return i.prototype.run=function(t){var e=x(t.possibleActionsLeftToExpand),n=this.applyAction_(t.mctsState.state,e),a=this.dataStore_.get(n);a||(a=new m(n),this.dataStore_.set(n,a));var r=t.addChild(a,this.generateActions_(n),e);return r},i}();/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */function C(i,t,e,n){return new(e||(e=Promise))(function(a,r){function s(o){try{c(n.next(o))}catch(l){r(l)}}function u(o){try{c(n.throw(o))}catch(l){r(l)}}function c(o){o.done?a(o.value):new e(function(l){l(o.value)}).then(s,u)}c((n=n.apply(i,[])).next())})}function M(i,t){var e={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]},n,a,r,s;return s={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function u(o){return function(l){return c([o,l])}}function c(o){if(n)throw new TypeError("Generator is already executing.");for(;e;)try{if(n=1,a&&(r=a[o[0]&2?"return":o[0]?"throw":"next"])&&!(r=r.call(a,o[1])).done)return r;switch(a=0,r&&(o=[0,r.value]),o[0]){case 0:case 1:r=o;break;case 4:return e.label++,{value:o[1],done:!1};case 5:e.label++,a=o[1],o=[0];continue;case 7:o=e.ops.pop(),e.trys.pop();continue;default:if(r=e.trys,!(r=r.length>0&&r[r.length-1])&&(o[0]===6||o[0]===2)){e=0;continue}if(o[0]===3&&(!r||o[1]>r[0]&&o[1]<r[3])){e.label=o[1];break}if(o[0]===6&&e.label<r[1]){e.label=r[1],r=o;break}if(r&&e.label<r[2]){e.label=r[2],e.ops.push(o);break}r[2]&&e.ops.pop(),e.trys.pop();continue}o=t.call(i,e)}catch(l){o=[6,l],a=0}finally{n=r=0}if(o[0]&5)throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}}var k=function(){function i(t,e,n,a,r,s,u,c,o){this.select_=t,this.expand_=e,this.simulate_=n,this.backPropagate_=a,this.bestChild_=r,this.generateActions_=s,this.dataStore_=u,this.duration_=c,this.explorationParam_=o}return i.prototype.getAction=function(t,e){return C(this,void 0,void 0,function(){var n=this,a,r,s,u;return M(this,function(c){switch(c.label){case 0:return a=this.createRootNode_(t),r=d(),s=new Promise(function(o){var l=function(){if(d()-r>=(e||n.duration_))return o();w(30).milliseconds(function(){var g=n.select_.run(a),N=n.simulate_.run(g.mctsState.state);n.backPropagate_.run(g,N)}),setTimeout(l)};l()}),[4,s];case 1:return c.sent(),u=this.bestChild_.run(a,!0),[2,u.action]}})})},i.prototype.getActionSync=function(t,e){var n=this,a=this.createRootNode_(t);w(e||this.duration_).milliseconds(function(){var s=n.select_.run(a),u=n.simulate_.run(s.mctsState.state);n.backPropagate_.run(s,u)});var r=this.bestChild_.run(a,!0);return r.action},i.prototype.createRootNode_=function(t){var e=this.dataStore_.get(t);e||(e=new m(t),this.dataStore_.set(t,e));var n=new T(e,this.generateActions_(t));return n},i}(),B=function(){function i(t){this.UCB1_=t}return i.prototype.run=function(t,e){var n=this;if(e===void 0&&(e=!1),!!t.children.length){var a=t.children.reduce(function(s,u){return s+u.mctsState.visits},0),r=t.children.reduce(function(s,u){return n.UCB1_.run(a,s.mctsState,e)>n.UCB1_.run(a,u.mctsState,e)?s:u});return r}},i}(),I=function(){function i(t){this.explorationParam_=t}return i.prototype.run=function(t,e,n){n===void 0&&(n=!1),n&&(this.explorationParam_=0);var a=e.reward/e.visits,r=Math.sqrt(Math.log(t)/e.visits);return a+this.explorationParam_*r},i}(),E=function(){function i(t,e,n,a,r){this.stateIsTerminal_=t,this.expand_=e,this.bestChild_=n,this.ucb1_=a,this.fpuParam_=r}return i.prototype.run=function(t){for(;!this.stateIsTerminal_(t.mctsState.state);){var e=this.bestChild_.run(t);if(!e)return this.expand_.run(t);if(t.isNotFullyExpanded()){var n=t.children.reduce(function(r,s){return r+s.mctsState.visits},0),a=this.ucb1_.run(n,e.mctsState);if(a<this.fpuParam_)return this.expand_.run(t)}t=e}return t},i}(),O=function(){function i(t,e,n,a){this.stateIsTerminal_=t,this.generateActions_=e,this.applyAction_=n,this.calculateReward_=a}return i.prototype.run=function(t){for(var e=t.player;!this.stateIsTerminal_(t);){var n=this.generateActions_(t),a=v(0,n.length-1),r=n[a];t=this.applyAction_(t,r)}return this.calculateReward_(t,e)},i}(),R=function(){function i(t,e){this.duration_=e.duration,this.explorationParam_=e.explorationParam||1.414,this.fpuParam_=e.fpuParam||1/0,this.decayingParam_=e.decayingParam||1,this.transpoTable_=e.transpoTable,this.init(t)}return i.prototype.init=function(t){var e;this.transpoTable_?e=new p(this.transpoTable_):e=new Map;var n=new y(e),a=new I(this.explorationParam_),r=new B(a),s=new P(t.applyAction,t.generateActions,n),u=new E(t.stateIsTerminal,s,r,a,this.fpuParam_),c=new O(t.stateIsTerminal,t.generateActions,t.applyAction,t.calculateReward),o=new _(this.decayingParam_);this.mcts_=new k(u,s,c,o,r,t.generateActions,n,this.duration_,this.explorationParam_)},i.prototype.getAction=function(t,e){return this.mcts_.getAction(t,e)},i.prototype.getActionSync=function(t,e){return this.mcts_.getActionSync(t,e)},i}(),D=function(){function i(t,e){var n=new A(t);this.controller_=new R(n,e)}return i.prototype.getAction=function(t,e){return this.controller_.getAction(t,e)},i.prototype.getActionSync=function(t,e){return this.controller_.getActionSync(t,e)},i}();const f=class f{static isValidMove(t,e,n,a){const r=a===1?2:1;if(t[e][n]!==0)return!1;for(const[s,u]of f.directions){let c=e+s,o=n+u,l=!1;for(;c>=0&&c<8&&o>=0&&o<8;){if(t[c][o]===r)l=!0;else if(t[c][o]===a){if(l)return!0;break}else break;c+=s,o+=u}}return!1}static getAvailableMoves(t,e){const n=[];for(let a=0;a<8;a++)for(let r=0;r<8;r++)f.isValidMove(t,a,r,e)&&n.push({x:a,y:r});return n}static applyMove(t,e,n){const a=e===1?2:1,r=t.map(s=>[...s]);r[n.x][n.y]=e;for(const[s,u]of f.directions){let c=n.x+s,o=n.y+u;const l=[];for(;c>=0&&c<8&&o>=0&&o<8;){if(r[c][o]===a)l.push({x:c,y:o});else if(r[c][o]===e){for(const g of l)r[g.x][g.y]=e;break}else break;c+=s,o+=u}}return r}static isGameOver(t){return!f.getAvailableMoves(t,1).length&&!f.getAvailableMoves(t,2).length}static getCurrentWinner(t){let e=0,n=0;for(let a=0;a<8;a++)for(let r=0;r<8;r++)t[a][r]===1&&e++,t[a][r]===2&&n++;return e>n?1:n>e?2:0}static evaluatePosition(t,e){let n=0;for(let a=0;a<8;a++)for(let r=0;r<8;r++)t[a][r]===e?n+=f.positionWeights[a][r]:t[a][r]!==0&&(n-=f.positionWeights[a][r]);return n}static applyAction(t,e){if(!e)return{board:t.board.map(s=>[...s]),player:t.player};const n=f.applyMove(t.board,t.player,e),a=t.player===1?2:1;let r=a;return f.getAvailableMoves(n,a).length||(r=t.player),{board:n,player:r}}};b(f,"directions",[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]]),b(f,"positionWeights",[[100,-20,10,5,5,10,-20,100],[-20,-50,-2,-2,-2,-2,-50,-20],[10,-2,5,1,1,5,-2,10],[5,-2,1,0,0,1,-2,5],[5,-2,1,0,0,1,-2,5],[10,-2,5,1,1,5,-2,10],[-20,-50,-2,-2,-2,-2,-50,-20],[100,-20,10,5,5,10,-20,100]]);let h=f;class j{constructor(){}findBestMove(t,e,n){const a={generateActions:this.generateActions,applyAction:this.applyAction,stateIsTerminal:this.stateIsTerminal,calculateReward:this.calculateReward},r={duration:n};return new D(a,r).getAction({board:t,player:e})}generateActions(t){return h.getAvailableMoves(t.board,t.player)}applyAction(t,e){return h.applyAction(t,e)}stateIsTerminal(t){return h.isGameOver(t.board)}calculateReward(t,e){let n=t;for(;!h.isGameOver(t.board);){const r=h.getAvailableMoves(n.board,n.player);r.map(u=>{const c=h.applyMove(t.board,t.player,u),o=h.evaluatePosition(c,t.player);return{action:u,score:o}}).sort((u,c)=>c.score-u.score).map(u=>u.action);const s=r[0];n=h.applyAction(n,s)}const a=h.getCurrentWinner(n.board);return a===e?-1:a!==e?1:0}}onmessage=async i=>{const{grid:t,player:e,reflexionTime:n}=i.data,r=await new j().findBestMove(t,e,n);postMessage({nextAction:r})}})();
